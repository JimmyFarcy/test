/**
 * @file computations.hpp 
 * @brief Ces méthodes regroupent les méthodes permettant l'adaptation d'un modèle non conforme à tetgen.
 */
#include "input_output/poly.h"
#include "input_output/progressioninfo.h"
#include <tools/octree44.hpp>
#include <tools/octree44_triangleElement.hpp>


#ifndef __MESH_COMPUTATIONS__
#define __MESH_COMPUTATIONS__


class OctreeResult
{
	public:
		OctreeResult(octreeTool::elementSize _exception):exception(_exception){};
	bool DotTriangleCollisionTest(const octreeTool::elementSize& staticCandidateIndex)
	{
		if(exception<staticCandidateIndex)
			results.push_back(staticCandidateIndex);
		return true;
	}
	std::vector<octreeTool::elementSize> results;
	octreeTool::elementSize exception;
};



class meshOperation
{
private:



	unsigned int stat_NbFaceSplitting;
	unsigned int stat_DestroyedFaces;
	unsigned int stat_NbPointsMerged;
	formatPOLY::t_model modelData;
	octreeTool::spaceElementContainer lstFaces;
	octreeTool::Octree44* modelOctree;
	
	int FindFaceWithSommet( const ivec3& sommetsSearch );
	//Retourne -1 si aucun point correspondant
	int FindIndexWithPosition( const vec3& position );
	//return vrai si la division a eu lieu
	//addedFaceOne -1 ou idface (si inséré)
	//addedFaceTwo -1 ou idface (si inséré)
	bool SplitTriangleByThree( formatPOLY::t_face& triangleToSplit , const int& splitCentre,int* addedFaceOne,int* addedFaceTwo  );

	//return faux si aucun traitement effectué
	bool OnCollisionDetectedSplitIt( formatPOLY::t_face& triangleOne, formatPOLY::t_face& triangleTwo, const vec3& position );
	bool OnCollisionDetectedDestroyIt( formatPOLY::t_face& triangleOne, formatPOLY::t_face& triangleTwo, const vec3& position );
	void PushNewFace(const formatPOLY::t_face& newFace);
	void ReBuildOctree();
	bool coplanarIntersection(int idface,int idfaceTest);
public:
	meshOperation(const char* polyFileName);
	~meshOperation();

	void mergeVertices();
	/**
	 * Correction d'une erreur dans le modèle
	 * @return Vrai si le modèle a été modifié à cause de collision ou de superposition de triangles
	 */
	bool MeshReconstruction();
	/**
	 * Supprime les triangles qui rentrent en intersection
	 */
	bool MeshDestroyIntersectingTriangles();
	/**
	 *  Supprime les faces ayant une aire égale à 0 m²
	 */
	void DestroyNoAreaFaces();
	//Les faces définies dans la structure en tant que faces à tester sont transférées dans la liste des faces standart.
	void TransferUserFaceToGlobalFaces();
	bool MeshDestroyCoplanarFaces();
	void ShowStats();
	void Save(const char* polyFileName);
	bool IsOk();
};


#endif